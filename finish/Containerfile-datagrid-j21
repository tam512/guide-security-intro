ARG INFINISPAN_IMAGE=icr.io/appcafe/websphere-liberty:kernel-java21-openj9-ubi-minimal
ARG BASE_IMAGE=icr.io/appcafe/websphere-liberty:full-java21-openj9-ubi-minimal

FROM $INFINISPAN_IMAGE AS infinispan-client

USER root
#RUN infinispan-client-setup.sh - gets old files so running the commands individually
RUN set -Eeox pipefail
#RUN microdnf -y update 
RUN microdnf -y install maven
RUN mkdir -p /opt/ibm/wlp/usr/shared/resources/infinispan
RUN echo '<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">  <modelVersion>4.0.0</modelVersion>   <groupId>io.openliberty</groupId>  <artifactId>openliberty-infinispan-client</artifactId>  <version>1.0</version>  <!-- https://mvnrepository.com/artifact/org.infinispan/infinispan-jcache-remote -->  <dependencies>    <dependency>      <groupId>org.infinispan</groupId>      <artifactId>infinispan-jcache-remote</artifactId>      <version>14.0.31.Final</version>    </dependency>  </dependencies></project>' > /opt/ibm/wlp/usr/shared/resources/infinispan/pom.xml
RUN mvn -f /opt/ibm/wlp/usr/shared/resources/infinispan/pom.xml versions:use-latest-releases -DallowMajorUpdates=false
RUN mvn -f /opt/ibm/wlp/usr/shared/resources/infinispan/pom.xml dependency:copy-dependencies -DoutputDirectory=/opt/ibm/wlp/usr/shared/resources/infinispan
# RUN microdnf remove -y maven
RUN microdnf clean all
RUN rm -f /opt/ibm/wlp/usr/shared/resources/infinispan/pom.xml
RUN rm -f /opt/ibm/wlp/usr/shared/resources/infinispan/jboss-transaction-api*.jar
RUN rm -rf ~/.m2
RUN chown -R 1001:0 /opt/ibm/wlp/usr/shared/resources/infinispan
RUN chmod -R g+rw /opt/ibm/wlp/usr/shared/resources/infinispan
USER 1001

FROM $BASE_IMAGE AS open-liberty-infinispan

COPY --chown=1001:0 --from=infinispan-client /opt/ibm/wlp/usr/shared/resources/infinispan /config/datagrid

ENV INFINISPAN_SERVICE_NAME=datagrid
ENV INFINISPAN_PASS=datagridPass

# set env variable so it won't fall back to default server start if restore fails
ENV CRIU_RESTORE_DISABLE_RECOVERY=true

COPY --chown=1001:0 ./target/guide-security-intro.war /config/apps/
COPY --chown=1001:0 ./src/main/liberty/config/server_datagrid.xml /config/server.xml
COPY --chown=1001:0 ./src/main/liberty/config/userRegistry.xml /config/userRegistry.xml
COPY --chown=1001:0 ./src/main/liberty/config/datagrid.xml /config/datagrid.xml

#DATAGRID files
COPY --chown=1001:0 ./datagrid /config/datagrid

# Setting for the verbose option
ARG VERBOSE=true
ARG FULL_IMAGE=true

# This script will add the requested XML snippets to enable Liberty features and grow image to be fit-for-purpose using featureUtility. 
# Only available in 'kernel-slim'. The 'full' tag already includes all features for convenience.

RUN if [ "$FULL_IMAGE" = "true" ] ; then echo "Skip running features.sh for full image" ; else features.sh ; fi

# This script will add the requested XML snippets and grow image to be fit-for-purpose
RUN configure.sh

# remove infinispan-client-sessioncache.xml generated by onfigure.sh to avoid conflict with DataGrid configuration that is present for quicksec
USER root
RUN rm -rf /config/configDropins/overrides/infinispan-client-sessioncache.xml
USER 1001

RUN checkpoint.sh afterAppStart
